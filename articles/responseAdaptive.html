<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Designs with Response-Adaptive Randomization • TrialSimulator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Designs with Response-Adaptive Randomization">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TrialSimulator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/actionFunctions.html">Specify Actions to Execute at Trial Milestones</a></li>
    <li><a class="dropdown-item" href="../articles/adaptiveDesign.html">An Example of Simulating a Trial with Adaptive Design</a></li>
    <li><a class="dropdown-item" href="../articles/conditionSystem.html">Condition System for Triggering Milestones in a Trial</a></li>
    <li><a class="dropdown-item" href="../articles/defineArms.html">Define and Summarize Arms in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineLongitudinalEndpoints.html">Define Longitudinal Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/defineNonTimeToEventEndpoints.html">Define Non-Time-to-Event Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/defineTimeToEventEndpoints.html">Define Time-to-Event Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/fixedDesign.html">An Example of Fixed Design with Two Correlated Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/responseAdaptive.html">Designs with Response-Adaptive Randomization</a></li>
    <li><a class="dropdown-item" href="../articles/simulatePfsAndOs.html">Simulate Correlated Progression-Free Survival and Overall Survival as Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/wrappers.html">Wrapper Functions of Common Statistical Methods in TrialSimulator</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/zhangh12/TrialSimulator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="responseAdaptive_files/kePrint-0.0.1/kePrint.js"></script><link href="responseAdaptive_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Designs with Response-Adaptive Randomization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/zhangh12/TrialSimulator/blob/main/vignettes/responseAdaptive.Rmd" class="external-link"><code>vignettes/responseAdaptive.Rmd</code></a></small>
      <div class="d-none name"><code>responseAdaptive.Rmd</code></div>
    </div>

    
    
<p>Response-adaptive randomization (RAR) can be a powerful strategy in
Phase II dose-finding trials. It allows sponsors to dynamically update
the randomization scheme at one or more interim analyses based on
accumulating data. By shifting allocation toward more promising
treatment arms, RAR can enhance the ethical and statistical efficiency
of the trial.</p>
<p>This vignette demonstrates how to simulate a trial with
response-adaptive design using the <code>TrialSimulator</code> package.
For further background, refer to <a href="https://www.mediana.us/MedianaDesigner/ADRand.pdf" class="external-link">this</a>
document from the <code>MedianaDesigner</code> package. Dr. Alex
Dmitrienko also provides a series of excellent online lectures on this
topic:</p>
<ul>
<li><p><a href="https://www.youtube.com/watch?v=-ADsHASLimM&amp;list=PL_qOo99xv_nRJU8MEBO_VzBjH8duFy01n&amp;index=3&amp;ab_channel=MedianaOnline" class="external-link">Part
1</a></p></li>
<li><p><a href="https://www.youtube.com/watch?v=2agD_9qP1cU&amp;t=1447s&amp;ab_channel=MedianaOnline" class="external-link">Part
2</a></p></li>
</ul>
<p>However, the original <code>MedianaDesigner::ADRand()</code> function
is no longer functional, even for examples provided on <a href="https://medianasoft.github.io/CaseStudyF1" class="external-link">this</a> page.
Therefore, this vignette focuses on implementing a similar
response-adaptive design using <code>TrialSimulator</code>. The core
algorithm for updating the randomization ratio is re-implemented based
on the logic of the <code>DoseFinding</code> package and may differ
slightly from that used in Dr. Dmitrienko’s materials.</p>
<div class="section level2">
<h2 id="simulation-settings">Simulation Settings<a class="anchor" aria-label="anchor" href="#simulation-settings"></a>
</h2>
<ul>
<li><p>We assume an <code>Emax</code> model for the endpoint
<code>fev1</code> (forced expiratory volume in 1 second) measured after
4 months of treatment. The maximum effect (0.1) is achieved at dose
100.</p></li>
<li>
<p>The trial includes one placebo arm and five active arms with
doses: 20, 25, 30, and 35.</p>
<ul>
<li>Patients are initially randomized equally across all five arms.</li>
</ul>
</li>
<li><p>A total of 200 patients are recruited over 36 months, with 50% of
enrollment expected by 24 months.</p></li>
<li><p>Two interim analyses are planned after 50 and 120 patients have
non-missing <code>fev1</code> readouts, i.e. pipeline patients are
excluded.</p></li>
<li><p>The final analysis is performed when data from all 200 patients
are available.</p></li>
<li>
<p>At each interim:</p>
<ul>
<li><p>Candidate dose-response models <code>Emax</code>,
<code>sigEmax</code>, and <code>quadratic</code> are fitted.</p></li>
<li><p>Bootstrap estimates from <code><a href="https://openpharma.github.io/DoseFinding/reference/maFitMod.html" class="external-link">DoseFinding::maFitMod()</a></code> are
used to calculate, for each dose
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>∈</mo><mo stretchy="false" form="prefix">{</mo><mn>20</mn><mo>,</mo><mn>25</mn><mo>,</mo><mn>30</mn><mo>,</mo><mn>35</mn><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">d \in \{20, 25, 30, 35\}</annotation></semantics></math>,
the probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>d</mi></msub><annotation encoding="application/x-tex">p_d</annotation></semantics></math>
that the estimated treatment effect exceeds 0.08.</p></li>
<li><p>The randomization ratio for each active dose is set proportional
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>d</mi></msub><annotation encoding="application/x-tex">p_d</annotation></semantics></math></p></li>
<li><p>The placebo ratio remains fixed at 20%.</p></li>
</ul>
</li>
<li><p>At the final analysis, a multiple contrast test is conducted
using data from all 200 patients.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="define-data-generator-of-fev1">Define Data Generator of <code>fev1</code><a class="anchor" aria-label="anchor" href="#define-data-generator-of-fev1"></a>
</h2>
<p>The following function generates <code>fev1</code> outcomes using the
assumed <code>Emax</code> model. It is later assigned as the generator
function when defining endpoints.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rng</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span>, <span class="va">dose</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">DoseFinding</span><span class="fu">::</span><span class="fu"><a href="https://openpharma.github.io/DoseFinding/reference/Mods.html" class="external-link">Mods</a></span><span class="op">(</span></span>
<span>    emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.6</span>, <span class="fl">12.5</span><span class="op">)</span>,</span>
<span>    placEff <span class="op">=</span> <span class="fl">1.25</span>, maxEff <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    fev1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fu">getResp</span><span class="op">(</span><span class="va">model</span>, doses <span class="op">=</span> <span class="va">dose</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-fev1-endpoints-for-each-arm">Define <code>fev1</code> Endpoints for Each Arm<a class="anchor" aria-label="anchor" href="#define-fev1-endpoints-for-each-arm"></a>
</h2>
<p>Each treatment arm is associated with an endpoint definition,
specifying the dose and data generator.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fev1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/endpoint.html">endpoint</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fev1'</span>, type <span class="op">=</span> <span class="st">'non-tte'</span>, readout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fev1 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 generator <span class="op">=</span> <span class="va">rng</span>, dose <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">pbo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arm.html">arm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'0.0'</span><span class="op">)</span></span>
<span><span class="va">pbo</span><span class="op">$</span><span class="fu">add_endpoints</span><span class="op">(</span><span class="va">fev1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fev1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/endpoint.html">endpoint</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fev1'</span>, type <span class="op">=</span> <span class="st">'non-tte'</span>, readout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fev1 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 generator <span class="op">=</span> <span class="va">rng</span>, dose <span class="op">=</span> <span class="fl">20.0</span><span class="op">)</span></span>
<span><span class="va">dose1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arm.html">arm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'20.0'</span><span class="op">)</span></span>
<span><span class="va">dose1</span><span class="op">$</span><span class="fu">add_endpoints</span><span class="op">(</span><span class="va">fev1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fev1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/endpoint.html">endpoint</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fev1'</span>, type <span class="op">=</span> <span class="st">'non-tte'</span>, readout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fev1 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 generator <span class="op">=</span> <span class="va">rng</span>, dose <span class="op">=</span> <span class="fl">25.0</span><span class="op">)</span></span>
<span><span class="va">dose2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arm.html">arm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'25.0'</span><span class="op">)</span></span>
<span><span class="va">dose2</span><span class="op">$</span><span class="fu">add_endpoints</span><span class="op">(</span><span class="va">fev1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fev1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/endpoint.html">endpoint</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fev1'</span>, type <span class="op">=</span> <span class="st">'non-tte'</span>, readout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fev1 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 generator <span class="op">=</span> <span class="va">rng</span>, dose <span class="op">=</span> <span class="fl">30.0</span><span class="op">)</span></span>
<span><span class="va">dose3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arm.html">arm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'30.0'</span><span class="op">)</span></span>
<span><span class="va">dose3</span><span class="op">$</span><span class="fu">add_endpoints</span><span class="op">(</span><span class="va">fev1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fev1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/endpoint.html">endpoint</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fev1'</span>, type <span class="op">=</span> <span class="st">'non-tte'</span>, readout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>fev1 <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>                 generator <span class="op">=</span> <span class="va">rng</span>, dose <span class="op">=</span> <span class="fl">35.0</span><span class="op">)</span></span>
<span><span class="va">dose4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arm.html">arm</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'35.0'</span><span class="op">)</span></span>
<span><span class="va">dose4</span><span class="op">$</span><span class="fu">add_endpoints</span><span class="op">(</span><span class="va">fev1</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-a-trial">Define a Trial<a class="anchor" aria-label="anchor" href="#define-a-trial"></a>
</h2>
<p>Here we define the trial object with 200 patients and an accrual
period of 36 months. The total trial duration is extended to 40 months
to account for a 4-month follow-up after last enrollment.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">accrual_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>end_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">24</span>, <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>                           piecewise_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span><span class="op">/</span><span class="fl">24</span>, <span class="fl">100</span><span class="op">/</span><span class="fl">12</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial.html">trial</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">'Trial-3415'</span>, n_patients <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1727811904</span>, duration <span class="op">=</span> <span class="fl">40</span>,</span>
<span>  enroller <span class="op">=</span> <span class="va">StaggeredRecruiter</span>, accrual_rate <span class="op">=</span> <span class="va">accrual_rate</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">trial</span><span class="op">$</span><span class="fu">add_arms</span><span class="op">(</span>sample_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, <span class="va">pbo</span>, <span class="va">dose1</span>, <span class="va">dose2</span>, <span class="va">dose3</span>, <span class="va">dose4</span><span class="op">)</span></span>
<span><span class="co">#&gt; Arm(s) &lt;0.0, 20.0, 25.0, 30.0, 35.0&gt; are added to the trial.</span></span>
<span><span class="co">#&gt; Randomization is done for 200 potential patients.</span></span>
<span><span class="co">#&gt; Data of 200 potential patients are generated for the trial with 5 arm(s) &lt;0.0, 20.0, 25.0, 30.0, 35.0&gt;.</span></span>
<span><span class="va">trial</span></span>
<span><span class="co">#&gt;  ⚕⚕ Trial Name:  Trial-3415  </span></span>
<span><span class="co">#&gt;  ⚕⚕ Description:  Trial-3415  </span></span>
<span><span class="co">#&gt;  ⚕⚕ # of Arms:  5  </span></span>
<span><span class="co">#&gt;  ⚕⚕ Registered Arms:  0.0, 20.0, 25.0, 30.0, 35.0  </span></span>
<span><span class="co">#&gt;  ⚕⚕ Sample Ratio:  1, 1, 1, 1, 1  </span></span>
<span><span class="co">#&gt;  ⚕⚕ # of Patients:  200  </span></span>
<span><span class="co">#&gt;  ⚕⚕ Planned Duration:  40  </span></span>
<span><span class="co">#&gt;  ⚕⚕ Random Seed:  1727811904</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="define-milestones-and-associated-actions">Define Milestones and Associated Actions<a class="anchor" aria-label="anchor" href="#define-milestones-and-associated-actions"></a>
</h2>
<p>Three milestones are defined: two interim analyses and one final
analysis. The same action is used for both interims, while a separate
one is used for the final.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stage1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'stage 1'</span>,</span>
<span>                    when <span class="op">=</span> <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'fev1'</span>, n <span class="op">=</span> <span class="fl">50</span><span class="op">)</span>,</span>
<span>                    action <span class="op">=</span> <span class="va">stage_action</span>, milestone_name <span class="op">=</span> <span class="st">'stage 1'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stage2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'stage 2'</span>,</span>
<span>                    when <span class="op">=</span> <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'fev1'</span>, n <span class="op">=</span> <span class="fl">120</span><span class="op">)</span>,</span>
<span>                    action <span class="op">=</span> <span class="va">stage_action</span>, milestone_name <span class="op">=</span> <span class="st">'stage 2'</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'final'</span>,</span>
<span>                   when <span class="op">=</span> <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'fev1'</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>,</span>
<span>                   action <span class="op">=</span> <span class="va">final_action</span><span class="op">)</span></span></code></pre></div>
<p>The <code>stage_action()</code> function is called at each interim
milestone to lock current data and update sample ratios based on
model-based probabilities. It utilities a helper function
<code>compute_sample_ratio()</code> which can be found in the Appendix
below.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stage_action</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  <span class="va">new_sample_ratio</span> <span class="op">&lt;-</span> <span class="fu">compute_sample_ratio</span><span class="op">(</span><span class="va">locked_data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">update_sample_ratio</span><span class="op">(</span>arm_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'0.0'</span>, <span class="st">'20.0'</span>, <span class="st">'25.0'</span>, <span class="st">'30.0'</span>, <span class="st">'35.0'</span><span class="op">)</span>,</span>
<span>                            sample_ratios <span class="op">=</span> <span class="va">new_sample_ratio</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">milestone_name</span>, <span class="st">': '</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">locked_data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span>, <span class="va">new_sample_ratio</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dose'</span>, <span class="st">'total_n'</span>, <span class="st">'new_ratio'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>At the final milestone, the function <code>final_action()</code>
performs the multiple contrast test and stores the result. It calls a
helper function <code>multiple_contrast_test()</code>, which can be
found in the Appendix below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_action</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="st">'final'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">'final: '</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">locked_data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'dose'</span>, <span class="st">'total_n'</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="fu">multiple_contrast_test</span><span class="op">(</span><span class="va">locked_data</span><span class="op">)</span>,</span>
<span>             name <span class="op">=</span> <span class="st">'MC_test'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="execute-a-trial">Execute a Trial<a class="anchor" aria-label="anchor" href="#execute-a-trial"></a>
</h2>
<p>After registering all milestones with a listener object, we simulate
the trial using <code>controller$run()</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">listener</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/listener.html">listener</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">listener</span><span class="op">$</span><span class="fu">add_milestones</span><span class="op">(</span><span class="va">stage1</span>, <span class="va">stage2</span>, <span class="va">final</span><span class="op">)</span></span>
<span><span class="co">#&gt; A milestone &lt;stage 1&gt; is registered.</span></span>
<span><span class="co">#&gt; A milestone &lt;stage 2&gt; is registered.</span></span>
<span><span class="co">#&gt; A milestone &lt;final&gt; is registered.</span></span>
<span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/controller.html">controller</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">listener</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, plot_event <span class="op">=</span> <span class="cn">TRUE</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; stage 1:</span></span>
<span><span class="co">#&gt;   dose total_n new_ratio</span></span>
<span><span class="co">#&gt; 1  0.0      13 0.2000000</span></span>
<span><span class="co">#&gt; 2 20.0      13 0.1056760</span></span>
<span><span class="co">#&gt; 3 25.0      13 0.1469556</span></span>
<span><span class="co">#&gt; 4 30.0      14 0.2253870</span></span>
<span><span class="co">#&gt; 5 35.0      13 0.3219814</span></span>
<span><span class="co">#&gt; stage 2:</span></span>
<span><span class="co">#&gt;   dose total_n  new_ratio</span></span>
<span><span class="co">#&gt; 1  0.0      31 0.20000000</span></span>
<span><span class="co">#&gt; 2 20.0      25 0.03908046</span></span>
<span><span class="co">#&gt; 3 25.0      26 0.10344828</span></span>
<span><span class="co">#&gt; 4 30.0      28 0.21839080</span></span>
<span><span class="co">#&gt; 5 35.0      43 0.43908046</span></span>
<span><span class="co">#&gt; final:</span></span>
<span><span class="co">#&gt;   dose total_n</span></span>
<span><span class="co">#&gt; 1  0.0      40</span></span>
<span><span class="co">#&gt; 2 20.0      26</span></span>
<span><span class="co">#&gt; 3 25.0      32</span></span>
<span><span class="co">#&gt; 4 30.0      39</span></span>
<span><span class="co">#&gt; 5 35.0      63</span></span>
<span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="va">controller</span><span class="op">$</span><span class="fu">get_output</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">kable</span><span class="op">(</span>escape <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu">kable_styling</span><span class="op">(</span>bootstrap_options <span class="op">=</span> <span class="st">"striped"</span>, </span>
<span>                full_width <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                position <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">scroll_box</span><span class="op">(</span>width <span class="op">=</span> <span class="st">"100%"</span><span class="op">)</span></span></code></pre></div>
<div style="border: 1px solid #ddd; padding: 5px; overflow-x: scroll; width:100%; ">
<table class="table table table-striped" style="width: auto !important; ">
<thead><tr>
<th style="text-align:left;">
trial
</th>
<th style="text-align:right;">
seed
</th>
<th style="text-align:right;">
milestone_time_&lt;stage 1&gt;
</th>
<th style="text-align:right;">
n_events_&lt;stage 1&gt;_&lt;patient_id&gt;
</th>
<th style="text-align:right;">
n_events_&lt;stage 1&gt;_&lt;fev1&gt;
</th>
<th style="text-align:left;">
n_events_&lt;stage 1&gt;_&lt;arms&gt;
</th>
<th style="text-align:right;">
milestone_time_&lt;stage 2&gt;
</th>
<th style="text-align:right;">
n_events_&lt;stage 2&gt;_&lt;patient_id&gt;
</th>
<th style="text-align:right;">
n_events_&lt;stage 2&gt;_&lt;fev1&gt;
</th>
<th style="text-align:left;">
n_events_&lt;stage 2&gt;_&lt;arms&gt;
</th>
<th style="text-align:right;">
milestone_time_&lt;final&gt;
</th>
<th style="text-align:right;">
n_events_&lt;final&gt;_&lt;patient_id&gt;
</th>
<th style="text-align:right;">
n_events_&lt;final&gt;_&lt;fev1&gt;
</th>
<th style="text-align:left;">
n_events_&lt;final&gt;_&lt;arms&gt;
</th>
<th style="text-align:left;">
MC_test
</th>
<th style="text-align:left;">
error_message
</th>
</tr></thead>
<tbody><tr>
<td style="text-align:left;">
Trial-3415
</td>
<td style="text-align:right;">
1727811904
</td>
<td style="text-align:right;">
15.76
</td>
<td style="text-align:right;">
66
</td>
<td style="text-align:right;">
50
</td>
<td style="text-align:left;">
c(13, 10….
</td>
<td style="text-align:right;">
30.28
</td>
<td style="text-align:right;">
153
</td>
<td style="text-align:right;">
120
</td>
<td style="text-align:left;">
c(31, 24….
</td>
<td style="text-align:right;">
39.88
</td>
<td style="text-align:right;">
200
</td>
<td style="text-align:right;">
200
</td>
<td style="text-align:left;">
c(40, 40….
</td>
<td style="text-align:left;">
TRUE
</td>
<td style="text-align:left;">
</td>
</tr></tbody>
</table>
</div>
<p>In the output, the columns
<code>n_event_&lt;milestone&gt;_&lt;arms&gt;</code> contain detailed
information on observed events or sample sizes per arm at each
milestone. It is evident that we have pipeline patients at both
interims.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">[</span>, <span class="st">'n_events_&lt;stage 1&gt;_&lt;arms&gt;'</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   X0.0 X20.0 X25.0 X30.0 X35.0   endpoint</span></span>
<span><span class="co">#&gt; 1   13    13    13    14    13 patient_id</span></span>
<span><span class="co">#&gt; 2   10    10    10    10    10       fev1</span></span>
<span></span>
<span><span class="va">output</span><span class="op">[</span>, <span class="st">'n_events_&lt;stage 2&gt;_&lt;arms&gt;'</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   X0.0 X20.0 X25.0 X30.0 X35.0   endpoint</span></span>
<span><span class="co">#&gt; 1   31    25    26    28    43 patient_id</span></span>
<span><span class="co">#&gt; 2   24    20    23    23    30       fev1</span></span>
<span></span>
<span><span class="va">output</span><span class="op">[</span>, <span class="st">'n_events_&lt;final&gt;_&lt;arms&gt;'</span><span class="op">]</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   X0.0 X20.0 X25.0 X30.0 X35.0   endpoint</span></span>
<span><span class="co">#&gt; 1   40    26    32    39    63 patient_id</span></span>
<span><span class="co">#&gt; 2   40    26    32    39    63       fev1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="appendix-codes-of-helper-functions">Appendix: Codes of Helper Functions<a class="anchor" aria-label="anchor" href="#appendix-codes-of-helper-functions"></a>
</h2>
<p>For completeness, the full code of the helper functions
<code>compute_sample_ratio()</code> and
<code>multiple_contrast_test()</code> is included below, which determine
the new sample ratio and performs the multiple contrast test.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">compute_sample_ratio</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">dose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">fev1</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dose</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  <span class="va">dose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">dose</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mu_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span>  <span class="va">S_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span></span>
<span>    <span class="va">ma_fit</span> <span class="op">&lt;-</span> <span class="fu">DoseFinding</span><span class="fu">::</span><span class="fu"><a href="https://openpharma.github.io/DoseFinding/reference/maFitMod.html" class="external-link">maFitMod</a></span><span class="op">(</span><span class="va">dose</span>, <span class="va">mu_hat</span>, S <span class="op">=</span> <span class="va">S_hat</span>,</span>
<span>                                    models <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"emax"</span>, <span class="st">"sigEmax"</span>, <span class="st">"quadratic"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">ma_fit</span>, doseSeq <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">35</span><span class="op">)</span>, summaryFct <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">pred</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="va">pred</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">.08</span><span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">sample_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.2</span>, <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">*</span> <span class="va">prob</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sample_ratio</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">multiple_contrast_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">candidate_models</span> <span class="op">&lt;-</span> <span class="fu">DoseFinding</span><span class="fu">::</span><span class="fu"><a href="https://openpharma.github.io/DoseFinding/reference/Mods.html" class="external-link">Mods</a></span><span class="op">(</span></span>
<span>    emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.6</span>, <span class="fl">12.5</span><span class="op">)</span>, sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30.5</span>, <span class="fl">3.5</span><span class="op">)</span>, quadratic <span class="op">=</span> <span class="op">-</span><span class="fl">0.00776</span>,</span>
<span>    placEff <span class="op">=</span> <span class="fl">1.25</span>, maxEff <span class="op">=</span> <span class="fl">0.15</span>, doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">30</span>, <span class="fl">35</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">data</span><span class="op">$</span><span class="va">dose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">arm</span><span class="op">)</span></span>
<span>  <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu">DoseFinding</span><span class="fu">::</span><span class="fu"><a href="https://openpharma.github.io/DoseFinding/reference/MCTtest.html" class="external-link">MCTtest</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="va">dose</span>, resp <span class="op">=</span> <span class="va">fev1</span>,</span>
<span>                               models <span class="op">=</span> <span class="va">candidate_models</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## at least one dose shows significant non-flatten pattern</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">tStat</span>, <span class="st">'pVal'</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">.05</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Han Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
