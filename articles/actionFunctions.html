<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Specify Actions to Execute at Trial Milestones • TrialSimulator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specify Actions to Execute at Trial Milestones">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TrialSimulator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.87.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/actionFunctions.html">Specify Actions to Execute at Trial Milestones</a></li>
    <li><a class="dropdown-item" href="../articles/adaptiveDesign.html">An Example of Simulating a Trial with Adaptive Design</a></li>
    <li><a class="dropdown-item" href="../articles/conditionSystem.html">Condition System for Triggering Milestones in a Trial</a></li>
    <li><a class="dropdown-item" href="../articles/defineArms.html">Define and Summarize Arms in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineLongitudinalEndpoints.html">Define Longitudinal Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineNonTimeToEventEndpoints.html">Define Non-Time-to-Event Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineTimeToEventEndpoints.html">Define Time-to-Event Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/designDocument.html">Modular Clinical Trial Simulation: Overview of Core Functions and Workflow</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/zhangh12/TrialSimulator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Specify Actions to Execute at Trial Milestones</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/zhangh12/TrialSimulator/blob/main/vignettes/actionFunctions.Rmd" class="external-link"><code>vignettes/actionFunctions.Rmd</code></a></small>
      <div class="d-none name"><code>actionFunctions.Rmd</code></div>
    </div>

    
    
<p>In <code>TrialSimulator</code>, we can define custom action functions
that are executed automatically when trial milestone are triggered. This
mechanism allows for simulating dynamic trial behavior such as:</p>
<ul>
<li><p>Interim analyses</p></li>
<li><p>Early stopping for efficacy or futility</p></li>
<li><p>Arm dropping or selection</p></li>
<li><p>Adaptive enrollment adjustments</p></li>
<li><p>Logging or tracking intermediate results</p></li>
<li><p>Anytime when trial data needs to be locked and accessed</p></li>
</ul>
<p>This vignette illustrates how to define such actions and assign them
to trial milestones.</p>
<div class="section level2">
<h2 id="define-trial-milestones">Define Trial Milestones<a class="anchor" aria-label="anchor" href="#define-trial-milestones"></a>
</h2>
<p>At a milestone, a snapshot of trial data by the triggered time is
granted to users for custom analysis. A milestone consists of:</p>
<ul>
<li><p><code>name</code>: name of a milestone. We can use
<code>trial$get_locked_data(milestone_name)</code> to request for a data
snapshot at the triggering time.</p></li>
<li><p><code>when</code>: conditions triggering a milestone. We can
refer to the vignette <a href="conditionSystem.html">Condition System
for Triggering Milestones in a Trial</a> for more information.</p></li>
<li><p><code>action</code>: a custom action function in which we can
analyze data snapshot, make decisions, and save analysis results for
summary later.</p></li>
</ul>
<p>For example, an interim is triggerred when the trial has run at least
20 months and at least 450 events have been observed for the endpoint
<code>PFS</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'interim analysis'</span>, </span>
<span>                     action <span class="op">=</span> <span class="va">doNothing</span>, </span>
<span>                     when <span class="op">=</span> <span class="fu"><a href="../reference/calendarTime.html">calendarTime</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                       <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'PFS'</span>, n <span class="op">=</span> <span class="fl">450</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span></code></pre></div>
<p>Note that <code>action</code> is set to a default function
<code>doNothing</code>. In that case, <code>TrialSimulator</code> will
only record triggering time for <code>interim</code> into a data frame
of output. This is useful when only triggering time is of interest given
a recruitment schedule and dropout of a trial.</p>
<p>We can define arbitrary number of milestones for a trial. For
example, a milestone for final analysis can be defined as follow</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'final analysis'</span>, </span>
<span>                   action <span class="op">=</span> <span class="va">doNothing</span>, </span>
<span>                   when <span class="op">=</span> <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'PFS'</span>, n <span class="op">=</span> <span class="fl">800</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                     <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'OS'</span>, n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here we complete a trial when sufficient number of events are
observed for two endpoints <code>PFS</code> and <code>OS</code> to
achieve certain planned powers.</p>
</div>
<div class="section level2">
<h2 id="custom-action-functions">Custom Action Functions<a class="anchor" aria-label="anchor" href="#custom-action-functions"></a>
</h2>
<p>In practice, we may want to analyze data at interim. In that case we
need to define a custom action function and pass it to
<code>action</code>. A custom action function always takes two
arguments</p>
<ul>
<li>
<code>trial</code>: a trial object returned from the function
<code><a href="../reference/trial.html">trial()</a></code>.</li>
<li>
<code>milestone_name</code>: a character of milestone name.</li>
</ul>
<p>The first line of code in an action function is always recommended to
be calling function <code>trial$get_locked_data()</code> to request for
data snapshot. It is then up to the users to analyze the data and make
decisions. In the example below, hazard ratio is estimated by fitting a
proportional harzard model, from which the p-value is also computed. The
return value of an action function does not matter.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  <span class="co">## assume that hr is estimate, and pval is p-value</span></span>
<span>  </span>
<span>  <span class="co">## no return value is needed in an action function</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="save-intermediate-results-in-action-functions">Save intermediate results in action functions<a class="anchor" aria-label="anchor" href="#save-intermediate-results-in-action-functions"></a>
</h3>
<p><code>TrialSimulator</code> supports several member functions to save
results during a trial. Result can be classified as -
<strong>output</strong> of the trial, i.e., it will be used to summarize
trial’s operating characteristics. The output of a trial is managed by
the <code>trial</code> object and stored in a private data frame of one
row. We cannot access or modify it directly. Instead, member functions
<code>trial$save()</code> and <code>trial$get_output()</code> should be
used to insert and extract outputs. Because the output is a data frame
of one row, <code>trial$save()</code> can only accept a scalar or a data
frame of one row.</p>
<ul>
<li>
<strong>intermediate results</strong> of the trial, i.e., it is
useful in subsequent analysis later (e.g., in action functions of other
milestones). For the purpose of avoiding the use of global variables
while enabling communication between milestones, intermediate results
can be saved by calling member function
<code>trial$save_custom_data()</code>. To extract it later, simply call
<code>trial$get_custom_data()</code>. Unlike <code>trial$save()</code>,
<code>trial$save_custom_data</code> can save any objects, which provides
flexibility.</li>
</ul>
<p>Here we give more details of those member functions.</p>
<ul>
<li><p><code>save(value, name)</code>: <code>value</code> can be a
scalar or a data frame to be inserted to the output of a trial. To
access one or more values anywhere later, call
<code>trial$get_output(cols = name)</code>.</p></li>
<li><p><code>save_custom_data(value, name)</code>: <code>value</code>
can be of any type that is stored as a private list with a trial. To
access the value anywhere later, call
<code>trial$get_custom_data(name)</code>.</p></li>
<li><p><code>bind(value, name)</code>: it is a special implementation of
<code>save_custom_data</code> as it only accepts a data frame as
<code>value</code>. If a data frame <code>name</code> already exists in
the trial by calling <code>save_custom_data</code>, <code>value</code>
will be row-binded to the existing data frame <code>name</code>.
Otherwise, a new data frame <code>name</code> will be created for trial.
To access the updated data frame anywhere later, call
<code>trial$get_custom_data(name)</code>. This is useful when endpoints
are tested at multiple milestones under a group sequential design and we
want to save estimates, p-values among others across milestones in a
data frame, so that we can test it with a graphical testing strategy
when all p-values are collected (i.e. at the last milestone).</p></li>
</ul>
<p>For example, the action function <code>action_at_interim</code> uses
<code>save</code> to store hazard ratio estimate and its p-value. Of
course, we can calculate something else and call the function
<code>save</code> to store.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  <span class="co">## assume that hr is estimate, and pval is p-value</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">hr</span>, name <span class="op">=</span> <span class="st">'pfs_interim_hazard_ratio'</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">pval</span>, name <span class="op">=</span> <span class="st">'pfs_interim_p_value'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## values of hr and pval can be accessed anywhere later by calling</span></span>
<span>  <span class="co">## trial$get_output(cols = 'pfs_interim_hazard_ratio')</span></span>
<span>  <span class="co">## trial$get_output(cols = 'pfs_interim_p_value')</span></span>
<span>  <span class="co">## trial$get_output(cols = c('pfs_interim_hazard_ratio', 'pfs_interim_hazard_ratio'))</span></span>
<span>  <span class="co">## If a colum specified in cols does not exist (e.g., typo in codes), </span></span>
<span>  <span class="co">## an informative error message will be prompted. </span></span>
<span>  </span>
<span>  <span class="co">## no return value is needed in an action function</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>If we want to pass something more complicate (e.g., a list) for
one-off calculation in other milestones, we can use the member function
<code>save_custom_data</code>. We modify the action function
<code>action_at_interim</code> as follow</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  <span class="co">## assume that hr is estimate, and pval is p-value</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">hr</span>, name <span class="op">=</span> <span class="st">'pfs_interim_hazard_ratio'</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">pval</span>, name <span class="op">=</span> <span class="st">'pfs_interim_p_value'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## assume that we also compute other values that may be useful in later milestone, </span></span>
<span>  <span class="co">## we save them in a list and call</span></span>
<span>  <span class="va">more_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>numeric <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                       string <span class="op">=</span> <span class="st">'abc'</span>, </span>
<span>                       list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>e1 <span class="op">=</span> <span class="fl">100</span>, e2 <span class="op">=</span> <span class="st">'AA'</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save_custom_data</span><span class="op">(</span>value <span class="op">=</span> <span class="va">more_results</span>, name <span class="op">=</span> <span class="st">'more_results'</span><span class="op">)</span></span>
<span>  <span class="co">## value of more_results can be accessed anywhere later by calling</span></span>
<span>  <span class="co">## tmp &lt;- trial$get_custom_data(name = 'more_results')</span></span>
<span>  </span>
<span>  <span class="co">## no return value is needed in an action function</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Han Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
