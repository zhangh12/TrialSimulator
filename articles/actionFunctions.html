<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Specify Actions to Execute at Trial Milestones • TrialSimulator</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specify Actions to Execute at Trial Milestones">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">TrialSimulator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.95.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/actionFunctions.html">Specify Actions to Execute at Trial Milestones</a></li>
    <li><a class="dropdown-item" href="../articles/adaptiveDesign.html">An Example of Simulating a Trial with Adaptive Design</a></li>
    <li><a class="dropdown-item" href="../articles/conditionSystem.html">Condition System for Triggering Milestones in a Trial</a></li>
    <li><a class="dropdown-item" href="../articles/defineArms.html">Define and Summarize Arms in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineLongitudinalEndpoints.html">Define Longitudinal Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineNonTimeToEventEndpoints.html">Define Non-Time-to-Event Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/defineTimeToEventEndpoints.html">Define Time-to-Event Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/fixedDesign.html">An Example of Fixed Design with Two Correlated Endpoints</a></li>
    <li><a class="dropdown-item" href="../articles/responseAdaptive.html">Designs with Response-Adaptive Randomization</a></li>
    <li><a class="dropdown-item" href="../articles/simulatePfsAndOs.html">Simulate Correlated Progression-Free Survival and Overall Survival as Endpoints in Clinical Trials</a></li>
    <li><a class="dropdown-item" href="../articles/wrappers.html">Wrapper Functions of Common Statistical Methods in TrialSimulator</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/zhangh12/TrialSimulator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Specify Actions to Execute at Trial Milestones</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/zhangh12/TrialSimulator/blob/v0.95.0/vignettes/actionFunctions.Rmd" class="external-link"><code>vignettes/actionFunctions.Rmd</code></a></small>
      <div class="d-none name"><code>actionFunctions.Rmd</code></div>
    </div>

    
    
<p>In <code>TrialSimulator</code>, we can define custom action functions
that will be executed automatically whenever a trial milestone is
reached. This mechanism provides a flexible way to simulate adaptive and
dynamic trial behaviors, such as:</p>
<ul>
<li><p>Conducting interim analyses</p></li>
<li><p>Early stopping for efficacy or futility</p></li>
<li><p>Dropping or selecting treatment arms</p></li>
<li><p>Adjusting enrollment rules adaptively</p></li>
<li><p>Logging or tracking intermediate results</p></li>
<li><p>Locking and exporting trial data snapshot at specific
points</p></li>
</ul>
<p>This vignette demonstrates how to define such actions, associate them
with milestones, and make use of them to enrich trial simulations.</p>
<div class="section level2">
<h2 id="define-trial-milestones">Define Trial Milestones<a class="anchor" aria-label="anchor" href="#define-trial-milestones"></a>
</h2>
<p>A milestone represents a pre-specified time point or condition during
the trial at which a snapshot of accumulated data becomes available for
custom analysis. Each milestone consists of three key elements:</p>
<ul>
<li><p><code>name</code>: the label of the milestone. A data snapshot at
the triggering time can be retrieved by calling
<code>trial$get_locked_data(milestone_name)</code>.</p></li>
<li><p><code>when</code>: the logical conditions that trigger the
milestone. Refer to the vignette <a href="conditionSystem.html">Condition System for Triggering Milestones
in a Trial</a> for more information.</p></li>
<li><p><code>action</code>: a function to be executed once the milestone
is reached. Within this function, we can analyze data snapshot, make
decisions, and store analysis results for later summary.</p></li>
</ul>
<p>For example, consider an interim analysis that is triggered once the
trial has been running for at least 20 months and at least 450 events
have occurred for the endpoint <code>PFS</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'interim analysis'</span>, </span>
<span>                     action <span class="op">=</span> <span class="va">doNothing</span>, </span>
<span>                     when <span class="op">=</span> <span class="fu"><a href="../reference/calendarTime.html">calendarTime</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                       <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'PFS'</span>, n <span class="op">=</span> <span class="fl">450</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span></code></pre></div>
<p>Note that in this example, <code>action</code> is set to the default
<code>doNothing</code> function. In such cases,
<code>TrialSimulator</code> will not perform additional computations but
will still record the triggering time of the milestone. This can be
useful when the sole interest is in timing of interim analysis given
recruitment and dropout assumptions.</p>
<p>Importantly, whenever a milestone is reached,
<code>TrialSimulator</code> <strong>automatically</strong> records a set
of standard outputs, even when <code>doNothing</code> is used. These are
summarized in the following table:</p>
<table style="width:99%;" class="table">
<caption>Automatically Saved Results At Triggered Milestones</caption>
<colgroup>
<col width="39%">
<col width="7%">
<col width="33%">
<col width="19%">
</colgroup>
<thead><tr class="header">
<th>Type of Results</th>
<th>Format</th>
<th>Column Naming Convention</th>
<th>Examples</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Time of triggering a milestone</td>
<td>scalar</td>
<td>
<p><code>milestone_time_&lt;...&gt;</code></p>
<p>where <code>...</code> is milestone name</p>
</td>
<td><code>milestone_name_&lt;interim&gt;</code></td>
</tr>
<tr class="even">
<td>Number of observed events for a time-to-event endpoint</td>
<td>scalar</td>
<td>
<p><code>n_events_&lt;...1&gt;_&lt;...2&gt;</code></p>
<p>where <code>...1</code> is milestone name and <code>...2</code> is
endpoint name</p>
</td>
<td><code>n_events_&lt;interim&gt;_&lt;PFS&gt;</code></td>
</tr>
<tr class="odd">
<td>Number of observed non-missing readouts for a non-TTE endpoint</td>
<td>scalar</td>
<td>
<p><code>n_events_&lt;...1&gt;_&lt;...2&gt;</code></p>
<p>where <code>...1</code> is milestone name and <code>...2</code> is
endpoint name</p>
</td>
<td><code>n_events_&lt;final&gt;_&lt;ORR&gt;</code></td>
</tr>
<tr class="even">
<td>Number of enrolled patients</td>
<td>scalar</td>
<td>
<p><code>n_events_&lt;...&gt;_&lt;patient_id&gt;</code></p>
<p>where <code>...</code> is milestone name</p>
</td>
<td><code>n_events_&lt;interim&gt;_&lt;patient_id&gt;</code></td>
</tr>
<tr class="odd">
<td>Number of observed events/readouts per arm for a TTE/non-TTE
endpoint</td>
<td>data frame</td>
<td>
<p><code>n_events_&lt;...&gt;_&lt;arms&gt;</code></p>
<p>where <code>...</code> is milestone name</p>
</td>
<td><code>n_events_&lt;final&gt;_&lt;arms&gt;</code></td>
</tr>
</tbody>
</table>
<p>We can define arbitrary number of milestones in a trial. For example,
the final analysis might be triggered when both <code>PFS</code> and
<code>OS</code> events reach their required numbers:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'final analysis'</span>, </span>
<span>                   action <span class="op">=</span> <span class="va">doNothing</span>, </span>
<span>                   when <span class="op">=</span> <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'PFS'</span>, n <span class="op">=</span> <span class="fl">800</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                     <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'OS'</span>, n <span class="op">=</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here the trial is considered complete once sufficient events are
observed for both endpoints to ensure targeted statistical power.</p>
<p>Note that a milestone is only triggered if</p>
<ul>
<li><p>its <code>when</code> condition is satisfied,
<strong>and</strong></p></li>
<li><p>the milestone has been registered to a
<code>listener</code>.</p></li>
</ul>
<p>The following code snippet shows how to register milestones and run a
trial with a controller. You may have seen it in many of the documents
of this package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">listener</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/listener.html">listener</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#' register milestones with listener</span></span>
<span><span class="va">listener</span><span class="op">$</span><span class="fu">add_milestones</span><span class="op">(</span><span class="va">interim</span>, <span class="va">final</span><span class="op">)</span></span>
<span><span class="va">controller</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/controller.html">controller</a></span><span class="op">(</span><span class="va">trial</span>, <span class="va">listener</span><span class="op">)</span></span>
<span><span class="va">controller</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="custom-action-functions">Custom Action Functions<a class="anchor" aria-label="anchor" href="#custom-action-functions"></a>
</h2>
<p>In most realistic scenarios, we do not simply want to record the
timing of a milestone and number of events/readouts. Instead, we want to
analyze the data snapshot available at that time and possibly take
actions based on the results. To achieve this, we define a custom action
function and assign it to the <code>action</code> argument of a
milestone.</p>
<p>A custom action function must always takes two arguments</p>
<ul>
<li>
<code>trial</code>: a trial object created by the function
<code><a href="../reference/trial.html">trial()</a></code>.</li>
<li>
<code>milestone_name</code>: a character string indicating the
milestone being triggered.</li>
</ul>
<p>The first step inside every action function should be to call
<code>trial$get_locked_data()</code> to retrieve the data snapshot.
After this, we are free to perform any analyses or decision-making
steps.</p>
<p>For example, the following action function illustrates how one might
analyze survival data at an interim milestone. Here, hazard ratios are
estimated from proportional hazard models, and p-values (or other
statistics) can also be calculated if desired.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## write your own codes to fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  </span>
<span>  <span class="co">## no return value is needed in an action function</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>By default, <code>TrialSimulator</code> prints the return value of an
action function to the console. Since this is often unnecessary, it is
good practice to end the function with <code>invisible(NULL)</code> to
suppress output. However, we can still return something for debugging
purpose.</p>
<p>One the functions is defined, it can be passed to the
<code>action</code> argument of a milestone:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/milestone.html">milestone</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">'interim analysis'</span>, </span>
<span>                     action <span class="op">=</span> <span class="va">action_at_interim</span>, </span>
<span>                     when <span class="op">=</span> <span class="fu"><a href="../reference/calendarTime.html">calendarTime</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">&amp;</span> </span>
<span>                       <span class="fu"><a href="../reference/eventNumber.html">eventNumber</a></span><span class="op">(</span><span class="st">'PFS'</span>, n <span class="op">=</span> <span class="fl">450</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span></code></pre></div>
<p>Thus, whenever the milestone is triggered, the action function will
be executed.</p>
<p>Within a custom action function, we can go beyond simple data access.
The main possibilities include</p>
<ul>
<li><p>performing statistical analyses;</p></li>
<li><p>saving intermediate results;</p></li>
<li><p>altering the trial through adaptation.</p></li>
</ul>
<p>Each of these topics will be discussed in the following sections.</p>
<div class="section level3">
<h3 id="perform-statistical-analyses-on-data-snapshot">Perform statistical analyses on data snapshot<a class="anchor" aria-label="anchor" href="#perform-statistical-analyses-on-data-snapshot"></a>
</h3>
<p>Statisticians rarely stop at just locking the data–we want to analyze
it!</p>
<p>A milestone provide an opportunity to perform formal analysis on the
accumulated data, guiding decisions such as continuing, adapting, or
stopping the trial.</p>
<p>Let’s revisit the interim milestone. The following example shows how
one might compute hazard ratios for two active arms (low and high dose)
compared against placebo. The action function extracts the snapshot of
patient-level data, fits separate Cox proportional hazards models, and
then computes the hazard ratios.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## write your own codes to fit coxph model on locked_data</span></span>
<span>  <span class="va">fit_high</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">PFS</span>, <span class="va">PFS_event</span><span class="op">)</span> <span class="op">~</span> <span class="va">arm</span>, </span>
<span>                    data <span class="op">=</span> <span class="va">locked_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">arm</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pbo'</span>, <span class="st">'high'</span><span class="op">)</span><span class="op">)</span></span>
<span>                    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fit_low</span> <span class="op">&lt;-</span> <span class="fu">coxph</span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">PFS</span>, <span class="va">PFS_event</span><span class="op">)</span> <span class="op">~</span> <span class="va">arm</span>, </span>
<span>                   data <span class="op">=</span> <span class="va">locked_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">arm</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'pbo'</span>, <span class="st">'low'</span><span class="op">)</span><span class="op">)</span></span>
<span>                   <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">hr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_high</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                   low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_low</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## write more codes to compute one- or two-sided p-values, etc. </span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function illustrates the flexibility of action functions: any
valid R code can be executed at the milestone. However, writing such
functions from scratch may become <strong>cumbersome</strong> and
<strong>error-prone</strong>, especially when:</p>
<ul>
<li><p>multiple treatment arms exist,</p></li>
<li><p>one-sided tests are required, or</p></li>
<li><p>different trial scenarios have varying arm names or
endpoints</p></li>
</ul>
<p>To reduce coding burden and promote standardization,
<code>TrialSimulator</code> provides a collection of <strong>helper
functions</strong> for common statistical analyses. These wrappers
ensure consistent inputs and outputs, making downstream use (such as
saving or combining results) much easier.</p>
<p>Here is a rewritten version of the interim action function using
these helper functions:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fit_PFS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitCoxph.html">fitCoxph</a></span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">PFS</span>, <span class="va">PFS_event</span><span class="op">)</span> <span class="op">~</span> <span class="va">arm</span>, </span>
<span>                      placebo <span class="op">=</span> <span class="st">'pbo'</span>, </span>
<span>                      data <span class="op">=</span> <span class="va">locked_data</span>, </span>
<span>                      alternative <span class="op">=</span> <span class="st">'less'</span>, </span>
<span>                      scale <span class="op">=</span> <span class="st">'hazard ratio'</span><span class="op">)</span> <span class="co"># also also request other scales</span></span>
<span>  </span>
<span>  <span class="va">fit_OS</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitLogrank.html">fitLogrank</a></span><span class="op">(</span><span class="fu">Surv</span><span class="op">(</span><span class="va">OS</span>, <span class="va">OS_event</span><span class="op">)</span> <span class="op">~</span> <span class="va">arm</span>, </span>
<span>                       placebo <span class="op">=</span> <span class="st">'pbo'</span>, </span>
<span>                       data <span class="op">=</span> <span class="va">locked_data</span>, </span>
<span>                       alternative <span class="op">=</span> <span class="st">'less'</span>, </span>
<span>                       <span class="va">biomarker1</span> <span class="op">==</span> <span class="st">'positive'</span> <span class="op">&amp;</span> </span>
<span>                         <span class="va">biomarker2</span> <span class="op">==</span> <span class="st">'negative'</span><span class="op">)</span> <span class="co"># specify subgroup through ...</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this example,</p>
<ul>
<li><p><code>fitCoxph</code> estimates hazard ratio for <code>PFS</code>
against placebo, with a one-sided test.</p></li>
<li><p><code>figLogrank</code> performs logrank test for
<code>OS</code>, restricted to a biomarker-defined subgroup through the
argument <code>...</code> in helper functions.</p></li>
</ul>
<p>Both helper functions return results in a standardized format, which
integrates seamlessly with other utilities of
<code>TrialSimulator</code>. This is particularly useful when saving
outputs across milestones or performing multiplicity adjustments.</p>
<p>For more complete description of these helper functions for common
statistical analyses, see the vignette <a href="wrappers.html">Wrapper
Functions of Common Statistical Methods in TrialSimulator</a>.</p>
<p>At this stage, we are only calculating statistics. In the next
section, we will show how to save these results for later use—either to
summarize operating characteristics or to carry information forward into
future milestones.</p>
</div>
<div class="section level3">
<h3 id="save-intermediate-results">Save intermediate results<a class="anchor" aria-label="anchor" href="#save-intermediate-results"></a>
</h3>
<p><code>TrialSimulator</code> offers dedicated member functions for
saving intermediate results during a trial. The stored information can
be broadly classified into two categories:</p>
<ul>
<li><p><strong>Trial output</strong>—results that directly contribute to
the summary of trial operating characteristics (e.g., effect estimates,
test decisions) or anything that we need for each simulated trial. They
are stored in a private single-row data frame within the
<code>trial</code> object. We cannot access or modify it directly.
Instead, they should be inserted and accessed using member functions
<code>trial$save()</code> and <code>trial$get_output()</code>. Since
outputs are stored in a single-row data frame, only scalars or
single-row data frame are accepted by <code>trial$save()</code></p></li>
<li><p><strong>auxiliary information</strong>—results that may be useful
in subsequent analysis (e.g., in action functions of other milestones).
Any results that are not directly part of trial-level summaries should
be considered as auxiliary information. These are stored using member
function <code>trial$save_custom_data()</code>. To retrieve it later,
simply call <code>trial$get()</code>. This mechanism provides a safe way
to pass data across milestones without relying on global variables.
Unlike <code>trial$save()</code>, <code>trial$save_custom_data()</code>
can save any objects, which provides flexibility.</p></li>
</ul>
<p>In addition, a convenience function <code>trial$bind()</code> is
provided for sequentially appending rows to a stored data frame—useful
when accumulating results across milestones.</p>
<p>Here we give more details of those member functions. We can also
refer to their manuals by running <code><a href="../reference/Trials.html">?Trials</a></code> in R console.</p>
<ul>
<li>
<p><code>save(value, name)</code>: saves a scalar or a single-row
data frame into the trial’s output.</p>
<ul>
<li><p>later retrieved with
<code>trial$get_output(cols = name)</code>.</p></li>
<li><p>calling <code>trial$get_output()</code> without argument returns
all saved outputs available so far.</p></li>
</ul>
</li>
<li>
<p><code>save_custom_data(value, name)</code>: saves an object of
any type as auxiliary information as a temporary and private list within
the trial.</p>
<ul>
<li>retrieved later by calling <code>trial$get(name)</code>.</li>
</ul>
</li>
<li>
<p><code>bind(value, name)</code>: a special case of
<code>save_custom_data</code> for data frames.</p>
<ul>
<li><p>If the named data frame already exists, the new
<code>value</code> is row-bound to it. Otherwise, a new data frame is
created and saved.</p></li>
<li><p>retrieved later by
<code>trial$get_custom_data(name)</code>.</p></li>
<li><p>particularly useful for accumulating results across multiple
milestones in group sequential designs. For example, we may want to save
estimates, p-values, etc. across milestones to a data frame, so that we
can test it with a graphical testing strategy when all p-values are
collected (i.e. at the last milestone).</p></li>
</ul>
</li>
</ul>
<div class="section level4">
<h4 id="example-1-saving-hazard-ratio-and-p-value">Example 1: saving hazard ratio and p-value<a class="anchor" aria-label="anchor" href="#example-1-saving-hazard-ratio-and-p-value"></a>
</h4>
<p>Below, the interim action function computes a hazard ratio
<code>hr</code> and its p-value <code>pval</code>, then saves them as
part of the trial output:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  <span class="co">## assume that hr is estimate, and pval is p-value</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">hr</span>, name <span class="op">=</span> <span class="st">'pfs_interim_hazard_ratio'</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">pval</span>, name <span class="op">=</span> <span class="st">'pfs_interim_p_value'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## values of hr and pval can be accessed anywhere later by calling</span></span>
<span>  <span class="co">## trial$get_output(cols = 'pfs_interim_hazard_ratio')</span></span>
<span>  <span class="co">## trial$get_output(cols = 'pfs_interim_p_value')</span></span>
<span>  <span class="co">## trial$get_output(cols = c('pfs_interim_hazard_ratio', 'pfs_interim_hazard_ratio'))</span></span>
<span>  <span class="co">## If a colum specified in cols does not exist (e.g., typo in codes), </span></span>
<span>  <span class="co">## an informative error message will be prompted. </span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-2-passing-complex-objects-between-milestones">Example 2: passing complex objects between milestones<a class="anchor" aria-label="anchor" href="#example-2-passing-complex-objects-between-milestones"></a>
</h4>
<p>Sometimes we want to carry more complex information forward, such as
lists of results, which cannot be stored in the single-row output. In
this case, we use <code>save_custom_data()</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## fit coxph model on locked_data</span></span>
<span>  <span class="co">## extract estimate and p-value of hazard ratio</span></span>
<span>  <span class="co">## assume that hr is estimate, and pval is p-value</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">hr</span>, name <span class="op">=</span> <span class="st">'pfs_interim_hazard_ratio'</span><span class="op">)</span></span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save</span><span class="op">(</span>value <span class="op">=</span> <span class="va">pval</span>, name <span class="op">=</span> <span class="st">'pfs_interim_p_value'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## assume that we also compute other values that may be useful in later milestone, </span></span>
<span>  <span class="co">## we save them in a list and call</span></span>
<span>  <span class="va">more_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>numeric <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                       string <span class="op">=</span> <span class="st">'abc'</span>, </span>
<span>                       list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>e1 <span class="op">=</span> <span class="fl">100</span>, e2 <span class="op">=</span> <span class="st">'AA'</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">trial</span><span class="op">$</span><span class="fu">save_custom_data</span><span class="op">(</span>value <span class="op">=</span> <span class="va">more_results</span>, name <span class="op">=</span> <span class="st">'more_results'</span><span class="op">)</span></span>
<span>  <span class="co">## value of more_results can be accessed anywhere later by calling</span></span>
<span>  <span class="co">## tmp &lt;- trial$get(name = 'more_results')</span></span>
<span>  </span>
<span>  <span class="co">## no return value is needed in an action function</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>In the final analysis, we can then retrieve both the saved trial
outputs and the auxiliary information:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_final</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## extract outputs</span></span>
<span>  <span class="va">pfs_hr_interim</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_output</span><span class="op">(</span>cols <span class="op">=</span> <span class="st">'pfs_interim_hazard_ratio'</span><span class="op">)</span></span>
<span>  <span class="va">pfs_hr_pval</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_output</span><span class="op">(</span>cols <span class="op">=</span> <span class="st">'pfs_interim_p_value'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## extract auxiliary information</span></span>
<span>  <span class="va">custom_list</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">'more_results'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-3-defining-auxiliary-information-before-the-trial-runs">Example 3: defining auxiliary information before the trial runs<a class="anchor" aria-label="anchor" href="#example-3-defining-auxiliary-information-before-the-trial-runs"></a>
</h4>
<p>All member functions discussed in this section can be called before
any milestone is triggered, as long as the <code>trial</code> object has
been created by calling the function <code><a href="../reference/trial.html">trial()</a></code>. For example,
we may want to define the level of family-wise error rate (FWER) once,
and then use it later in interim and final analysis:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trial.html">trial</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="co">## initialize a trial with necessary arguments in ...</span></span>
<span><span class="va">trial</span><span class="op">$</span><span class="fu">add_arms</span><span class="op">(</span>sample_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">pbo</span>, <span class="va">low</span>, <span class="va">high</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trial</span><span class="op">$</span><span class="fu">save_custom_data</span><span class="op">(</span>value <span class="op">=</span> <span class="fl">0.025</span>, name <span class="op">=</span> <span class="st">'fwer'</span><span class="op">)</span></span></code></pre></div>
<p>This auxiliary information can then be retrieved in later action
functions to adjust boundaries or multiplicity procedures:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">action_at_interim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## compute p-values of PFS and OS at interim</span></span>
<span>  <span class="co">## then extract FWER</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fwer'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## compute decision boundaries at interim based on FWER</span></span>
<span>  <span class="co">## then test PFS and OS</span></span>
<span>  </span>
<span>  <span class="co">## save testing results for interim</span></span>
<span>  <span class="co"># trial$save(...)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">action_at_final</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trial</span>, <span class="va">milestone_name</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">locked_data</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get_locked_data</span><span class="op">(</span><span class="va">milestone_name</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## compute p-values of PFS and OS at final</span></span>
<span>  <span class="co">## then extract FWER and testing result at interim to adjust boundaries</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="va">trial</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>name <span class="op">=</span> <span class="st">'fwer'</span><span class="op">)</span></span>
<span>  <span class="co"># interim_results &lt;- trial$get_output(...)</span></span>
<span>  </span>
<span>  <span class="co">## test PFS and OS again</span></span>
<span>  </span>
<span>  <span class="co">## save testing results for final</span></span>
<span>  <span class="co"># trial$save(...)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span></code></pre></div>
<p>In summary, <code>TrialSimulator</code> provides a structured saving
system that allows users to:</p>
<ul>
<li><p>record scalar results directly into trial outputs;</p></li>
<li><p>carry forward complex objects across milestones, and</p></li>
<li><p>accumulate data frames across multiple milestones.</p></li>
</ul>
<p>This ensures smooth information flow between milestones and avoids
ad-hoc workarounds such as global variables.</p>
</div>
</div>
<div class="section level3">
<h3 id="alter-a-trial-via-adaptation">Alter a trial via adaptation<a class="anchor" aria-label="anchor" href="#alter-a-trial-via-adaptation"></a>
</h3>
<p>Beyond analyzing data and saving results, one of the most powerful
uses of action functions is the ability to adapt the ongoing trial.</p>
<p>Adaptation means that trial features—such as randomization ratios,
sample size, trial duration, or active arms—can be modified in response
to accumulated data. This reflects how many modern clinical trials are
designed in practice, aiming to increase efficiency, ethical and cost
balance.</p>
<p>In <code>TrialSimulator</code>, such adaptations are implemented
directly within action functions. At a milestone, after retrieving the
locked data and performing statistical analyses, the action function can
call methods of the <code>trial</code> object to alter its internal
state. These changes will then influence the subsequent course of the
trial simulation.</p>
<p>Adaptations that are currently supported are summarized below:</p>
<table style="width:99%;" class="table">
<colgroup>
<col width="21%">
<col width="38%">
<col width="39%">
</colgroup>
<thead><tr class="header">
<th>Adaptation</th>
<th>Member Function</th>
<th>Use Case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Remove an arm</td>
<td><code>trial$remove_arms()</code></td>
<td>dose selection; seamless design</td>
</tr>
<tr class="even">
<td>Add an arm</td>
<td><code>trial$add_arms()</code></td>
<td>adaptive platform trials</td>
</tr>
<tr class="odd">
<td>Update sample ratio</td>
<td><code>trial$update_sample_ratio()</code></td>
<td>response-adaptive design</td>
</tr>
<tr class="even">
<td>Extend trial duration</td>
<td>
<code>trial$set_duration()</code> or add a event-driven
milestone</td>
<td>actual patient or event accrual is slower than expected</td>
</tr>
<tr class="odd">
<td>Increase sample size<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;experimental&lt;/p&gt;"><sup>1</sup></a>
</td>
<td><code>trial$set_sample_size()</code></td>
<td>sample size reassessment</td>
</tr>
<tr class="even">
<td>Eliminate sub-population<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;work in progress&lt;/p&gt;"><sup>2</sup></a>
</td>
<td><code>trial$update_generator()</code></td>
<td>enrichment design</td>
</tr>
</tbody>
</table>
<p>These adaptive features allow users to simulate complex, data-driven
designs where trial conduct is not static but evolves in response to
accumulating evidence. At the time of writing, the vignette dedicated to
trial adaptation is still under development. Detailed examples will be
provided in that vignette.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Han Zhang.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
